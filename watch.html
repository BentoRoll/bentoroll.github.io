<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch - BentoRoll</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/x-icon" href="https://i.ibb.co/pjJPbymj/image.png">
</head>
<body>
<header>
    <div class="logo">
        <img src="https://i.ibb.co/pjJPbymj/image.png" alt="BentoRoll Logo">
        <h1>BentoRoll</h1>
    </div>
    <nav>
        <a href="index.html">Home</a>
    </nav>
</header>

<main class="watch-page">
    <div class="watch-container" id="player-container">
        <!-- iframe will be injected here -->
    </div>
    
    <section class="episode-details">
        <h2 id="episode-title" class="watch-title">Loading...</h2>
        <p id="episode-description" class="episode-description-preview"></p>

        <div class="episode-version-buttons" id="version-buttons"></div>

        <div class="episode-nav-buttons">
            <button id="prev-btn" class="nav-button prev-button" disabled>
                &larr; Previous
            </button>
            <button id="next-btn" class="nav-button next-button" disabled>
                Next &rarr;
            </button>
        </div>
    </section>
</main>

<footer>
    <p>&copy; 2025 BentoRoll. All rights not reserved.</p>
</footer>

<script>
const params = new URLSearchParams(window.location.search);
const epNumStr = params.get('episode');
const epNum = parseInt(epNumStr); 
const seriesSlug = params.get('series') || "gachiakuta";
let version = params.get('version') || 'sub'; 

// DOM Elements
const episodeTitle = document.getElementById('episode-title');
const episodeDesc = document.getElementById('episode-description');
const playerContainer = document.getElementById('player-container');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const versionButtons = document.getElementById('version-buttons');

const capitalize = s => typeof s === 'string' ? s.charAt(0).toUpperCase() + s.slice(1) : '';

const navigateToEpisode = (newEpisodeNum, newVersion = version) => {
    window.location.href = `watch.html?series=${seriesSlug}&episode=${newEpisodeNum}&version=${newVersion}`;
};

fetch(`data/${seriesSlug}/episodes.json`)
.then(res => {
    if (!res.ok) throw new Error('Failed to load episodes data');
    return res.json();
})
.then(episodes => {
    episodes.sort((a, b) => a.episode - b.episode);
    const currentEpIndex = episodes.findIndex(e => e.episode === epNum);
    const ep = currentEpIndex !== -1 ? episodes[currentEpIndex] : null;

    if(ep){
        // Determine which URL to use
        let videoUrl = "#";
        if(ep.videos){
            if(version === 'sub' && ep.videos.sub) videoUrl = ep.videos.sub;
            else if(version === 'dub' && ep.videos.dub) videoUrl = ep.videos.dub;
            else videoUrl = ep.videos.sub || ep.videos.dub; 
        }

        // Inject iframe
        playerContainer.innerHTML = `
            <iframe 
                src="${videoUrl}" 
                width="100%" 
                height="600" 
                allowfullscreen 
                allowtransparency 
                allow="autoplay" 
                scrolling="no" 
                frameborder="0">
            </iframe>
        `;

        // Update Title and Description
        episodeTitle.textContent = `${ep.series || capitalize(seriesSlug)} Episode ${ep.episode}: ${ep.title}`;
        episodeDesc.textContent = ep.description || "No description available for this episode.";
        document.title = `${ep.series || capitalize(seriesSlug)} Ep ${ep.episode} | BentoRoll`;

        // Version buttons
        versionButtons.innerHTML = '';
        if(ep.videos?.sub){
            const subBtn = document.createElement('button');
            subBtn.textContent = 'Sub';
            subBtn.className = version === 'sub' ? 'version-button active' : 'version-button';
            subBtn.onclick = () => navigateToEpisode(ep.episode, 'sub');
            versionButtons.appendChild(subBtn);
        }
        if(ep.videos?.dub){
            const dubBtn = document.createElement('button');
            dubBtn.textContent = 'Dub';
            dubBtn.className = version === 'dub' ? 'version-button active' : 'version-button';
            dubBtn.onclick = () => navigateToEpisode(ep.episode, 'dub');
            versionButtons.appendChild(dubBtn);
        }

        // Navigation buttons
        const prevEp = episodes[currentEpIndex - 1];
        const nextEp = episodes[currentEpIndex + 1];

        if(prevEp){
            prevBtn.disabled = false;
            prevBtn.textContent = `← Ep ${prevEp.episode}`;
            prevBtn.onclick = () => navigateToEpisode(prevEp.episode, version);
        } else {
            prevBtn.textContent = '← First Episode';
        }

        if(nextEp){
            nextBtn.disabled = false;
            nextBtn.textContent = `Ep ${nextEp.episode} →`;
            nextBtn.onclick = () => navigateToEpisode(nextEp.episode, version);
        } else {
            nextBtn.textContent = 'Last Episode →';
        }
    } else {
        episodeTitle.textContent = `Episode ${epNumStr} not found in series ${capitalize(seriesSlug)}.`;
        episodeDesc.style.display = 'none';
        playerContainer.style.display = 'none';
        versionButtons.style.display = 'none';
    }
})
.catch(error => {
    console.error("Error loading episode data:", error);
    episodeTitle.textContent = "Error loading episode data.";
    episodeDesc.style.display = 'none';
    playerContainer.style.display = 'none';
    versionButtons.style.display = 'none';
});
</script>
</body>
</html>
